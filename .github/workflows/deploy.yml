name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-2

jobs:
  # CI Job: ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ì´ë¯¸ì§€ ìƒì„±
  build-and-test:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # JDK ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Gradle ê¶Œí•œ ì„¤ì •
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run tests
        run: ./gradlew test

      # JAR ë¹Œë“œ (SNAPSHOT íŒŒì¼ ìƒì„±)
      - name: Build with Gradle
        run: ./gradlew clean build

      # AWS ìžê²©ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:latest

  # CD Job: ë°°í¬
  deploy:
    name: Deploy to EC2 instance
    runs-on: ubuntu-latest
    needs: build-and-test

    environment:
      name: production
      url: http://${{ secrets.EC2_HOST }}:8080

    steps:
      # EC2 ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            echo "ðŸ”§ Configuring AWS CLI..."
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region ap-northeast-2
            
            echo "ðŸ”‘ Logging in to ECR..."
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
            
            echo "â¹ï¸ Stopping existing services..."
            docker-compose down || true
            
            echo "ðŸ“¥ Pulling latest image..."
            docker pull ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest
            
            echo "ðŸ“ Creating environment file..."
            cat > .env << EOF
            ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
            ECR_REPOSITORY=${{ secrets.ECR_REPOSITORY }}
            MYSQL_URL=${{ secrets.MYSQL_URL }}
            MYSQL_USERNAME=${{ secrets.MYSQL_USERNAME }}
            MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ACCESSTOKEN_EXPIRATION=${{ secrets.JWT_ACCESSTOKEN_EXPIRATION }}
            JWT_REFRESHTOKEN_EXPIRATION=${{ secrets.JWT_REFRESHTOKEN_EXPIRATION }}
            REDIS_HOST=redis
            REDIS_PORT=6379
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
            EOF
            
            echo "ðŸš€ Starting services..."
            docker-compose up -d
            
            echo "â³ Waiting for services to be ready..."
            sleep 30
            
            echo "ðŸ§¹ Cleaning up unused images..."
            docker image prune -f
            
            echo "âœ… Deployment completed successfully!"